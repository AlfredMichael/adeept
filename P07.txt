import os
import json
import sys

def merge_ndjson(directory, output_file="merged.ndjson"):
    with open(output_file, "w", encoding="utf-8") as out:
        total = 0

        for filename in os.listdir(directory):
            if filename.endswith(".json") or filename.endswith(".ndjson"):
                filepath = os.path.join(directory, filename)

                try:
                    with open(filepath, "r", encoding="utf-8") as f:
                        valid = True
                        for i, line in enumerate(f, start=1):
                            line = line.strip()
                            if not line:
                                continue

                            try:
                                json.loads(line)
                            except json.JSONDecodeError as e:
                                print(f"[INVALID] {filename} (line {i}) - {e}")
                                valid = False
                                break

                            out.write(line + "\n")
                            total += 1

                        if valid:
                            print(f"[VALID]   {filename}")

                except Exception as e:
                    print(f"[ERROR]   {filename} - {e}")

    print(f"\nMerged {total} lines into {output_file}")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python merge.py <directory> [output_file]")
        sys.exit(1)

    directory = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else "merged.ndjson"

    merge_ndjson(directory, output_file)